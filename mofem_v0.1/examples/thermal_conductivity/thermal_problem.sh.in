#!/bin/sh

while test $# -gt 0; do
        case "$1" in
                -h|--help)
                        echo "convergence_study"
                        echo " "
                        echo "convergence_study [arguments]"
                        echo " "
                        echo "options:"
                        echo "-h, --help"
                        echo "-f, --file_name=FILE"
			echo "-o, --orders=1,2,3,4,5 (max is 5)\"" 
			echo "-d, --dir=DIR_NAME"
			echo "-p, --proc=NUMBER_OF_PROCESSORS"
                        exit 0
                        ;;
                -f)
                        shift
                        if test $# -gt 0; then
                                export FILE=$1
                        else
                                echo "no file name specified"
                                exit 1
                        fi
                        shift
                        ;;
                --file_name*)
                        export FILE=`echo $1 | sed -e 's/^[^=]*=//g'`
                        shift
                        ;;
                -d)
                        shift
                        if test $# -gt 0; then
                                export DIR_NAME=$1
                        else
                                echo "no file name specified"
                                exit 1
                        fi
                        shift
                        ;;
                --dir*)
                        export DIR_NAME=`echo $1 | sed -e 's/^[^=]*=//g'`
                        shift
                        ;;
		-o)
                        shift
                        if test $# -gt 0; then
                                export ORDERS=$1
                        else
                                echo "no griffith energy specified"
                                exit 1
                        fi
                        shift
                        ;;
                --orders*)
                        export ORDERS=`echo $1 | sed -e 's/^[^=]*=//g'`
                        shift
                        ;;

		-p)
                        shift
                        if test $# -gt 0; then
                                export NB_PROC=$1
                        else
                                echo "no griffith energy specified"
                                exit 1
                        fi
                        shift
                        ;;
                --proc*)
                        export NB_PROC=`echo $1 | sed -e 's/^[^=]*=//g'`
                        shift
                        ;;
		--pc_factor_mat_solver_package*) 
                        export PCFACTOR=`echo $1 | sed -e 's/^[^=]*=//g'`
                        shift
                        ;;
                *)
                        break
                        ;;
        esac
done

if [ -z ${FILE+x} ]; then 
  echo "Mesh file is unset, convergence_study --help"
fi

if [ -z ${ORDERS+x} ]; then 
  echo "Approximation order is unset, convergence_study --help"
  exit 1
fi

if [ -z ${NB_PROC+x} ]; then 
  NB_PROC=1
fi

if [ -z ${PCFACTOR+x} ]; then 
  PCFACTOR=superlu_dist
fi

OPTIONS_MATERIAL_FORCE="-pc_factor_mat_solver_package $PCFACTOR"

BIN_PATH="@CMAKE_CURRENT_BINARY_DIR@"
MPIRUN="@MPI_RUN@ -np $NB_PROC" 

if [ -z ${DIR_NAME+x} ]; then 
  DIR_SURFIX=`date "+DATE-%Y-%m-%d_TIME_%H_%M_%S"`
  DIR_PREFIX=`basename $FILE .cub`
  DIR_PREFIX=`basename $DIR_PREFIX .h5m`
  export DIR_NAME=material_forces_"$DIR_PREFIX"_"$DIR_SURFIX"
fi

if [ ! -d $DIR_NAME ]; then
  mkdir $DIR_NAME
fi

$MPIRUN $BIN_PATH/thermal_conductivity \
      -my_file cub_thermal_problem.cub \
      -ksp_type fgmres -ksp_gmres_restart 30 \
      -pc_type lu -pc_factor_mat_solver_package $PCFACTOR \
      -ksp_monitor -my_order $order -my_max_pot_proc_ref_level 1 \
      -log_summary 2>&1 | tee -a $DIR_NAME/log_solution

if [ $? -ne 0 ]; then
  exit $?
fi

mv out.vtk $DIR_NAME/out_"$order"_"$ref_level".vtk 
mv out_post_proc.vtk $DIR_NAME/out_stresses_"$order"_"$ref_level".vtk 
