image: ubuntu:precise

pipelines:
  default:
    - step:
        script:
          -
          >
            sudo apt-get install -y
            build-essential
            gcc
            g++
            libopenmpi-dev
            openmpi-bin
            openssh-server
            libblas-dev
            liblapack-dev
          - cd /
          - sudo wget --quiet https://www.dropbox.com/s/axa48op5mevukfj/mofem_env.tar.gz
          - sudo tar -xzf mofem_env.tar.gz
          - sudo chmod -R aug+rX /opt
          - sudo rm -f mofem_env.tar.gz
          - echo PWD $PWD
          - export MOFEM_SRC_DIR=$PWD
          - export MOFEM_INSTALL_DIR=$PWD/um
          - export MOFEM_BUILD_DIR=$PWD/lib
          - echo MOFEM_SRC_DIR $MOFEM_SRC_DIR
          - echo MOFEM_INSTALL_DIR $MOFEM_INSTALL_DIR
          - echo MOFEM_BUILD_DIR $MOFEM_BUILD_DIR
          - mkdir $MOFEM_BUILD_DIR
          - cd $MOFEM_BUILD_DIR
          - echo "Configure"
          -
          >
            /opt/bin/cmake
            -DCMAKE_BUILD_TYPE=MinSizeRel
            -DBUILD_SHARED_LIBS=1
            -DCMAKE_CXX_FLAGS="-Wall"
            -DPETSC_DIR=$PETSC_DIR
            -DPETSC_ARCH=$PETSC_ARCH
            -DMOAB_DIR=$PETSC_DIR/$PETSC_ARCH
            -DWITH_ADOL-C=1
            -DCMAKE_INSTALL_PREFIX=$MOFEM_INSTALL_DIR
            $MOFEM_SRC_DIR/mofem
          - echo "Build"
          - make install
          - /opt/bin/ctest --output-on-failure
          - export MOFEM_INSTALL_DIR=/build/um
          - echo "Configure users modules"
          - cd $MOFEM_INSTALL_DIR
          - /opt/bin/cmake users_modules
          - echo "Build users modules"
          - cd $MOFEM_INSTALL_DIR/basic_finite_elements/atom_tests
          - make
          - /opt/bin/ctest --output-on-failure
          - echo "All done"
