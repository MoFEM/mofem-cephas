FROM likask/ubuntu_mofem:v0.7

MAINTAINER Lukasz.Kaczmarczyk@glasgow.ac.uk

RUN adduser -q developer

# Set environment
ENV BUILD_DIR /build
ENV MOFEM_SRC_DIR $BUILD_DIR/src
ENV MOFEM_BUILD_DIR $BUILD_DIR/opt
ENV MOFEM_INSTALL_DIR $BUILD_DIR/um

ENV PETSC_VERSION 3.7.2
ENV PETSC_DIR=/opt/petsc
ENV PETSC_ARCH=arch-linux2-c-opt

RUN mkdir $BUILD_DIR && chown developer $BUILD_DIR
USER developer

RUN git clone https://bitbucket.org/likask/mofem-cephas.git $MOFEM_SRC_DIR
#RUN cd $MOFEM_SRC_DIR && git pull

RUN mkdir $MOFEM_BUILD_DIR \
&& cd $MOFEM_BUILD_DIR \
&& cmake \
-DCMAKE_BUILD_TYPE=Release \
-DCMAKE_CXX_FLAGS="-Wall -std=c++11" \
-DPETSC_DIR=$PETSC_DIR \
-DPETSC_ARCH=$PETSC_ARCH \
-DMOAB_DIR=$PETSC_DIR/$PETSC_ARCH \
-DADOL-C_DIR=/usr \
-DWITH_TETGEN=1 \
-DBUILD_SHARED_LIBS=yes \
-DCMAKE_INSTALL_PREFIX=$MOFEM_INSTALL_DIR \
$MOFEM_SRC_DIR/mofem

RUN cd $MOFEM_BUILD_DIR && make && make install
RUN cd $MOFEM_BUILD_DIR && ctest -D Experimental; echo "Tests Done"

RUN cd $MOFEM_SRC_DIR/mofem/users_modules && git clone https://bitbucket.org/likask/mofem_um_obsolete obsolete
RUN cd $MOFEM_SRC_DIR/mofem/users_modules && git clone https://bitbucket.org/likask/mofem_um_minimal_surface_equation minimal_surface_equation
RUN cd $MOFEM_SRC_DIR/mofem/users_modules && git clone https://bitbucket.org/likask/mofem_um_gels gels
RUN cd $MOFEM_SRC_DIR/mofem/users_modules && git clone https://bitbucket.org/likask/mofem_um_small_strain_plasticity small_strain_plasticity
RUN cd $MOFEM_SRC_DIR/mofem/users_modules && git clone https://bitbucket.org/likask/mofem_um_homogenisation homogenisation
RUN cd $MOFEM_SRC_DIR/mofem/users_modules && git clone https://bitbucket.org/likask/mofem_um_solid_shell_prism_element solid_shell_prism_element
RUN cd $MOFEM_SRC_DIR/mofem/users_modules && git clone https://bitbucket.org/likask/mofem_um_bone_remodelling bone_remodelling

RUN cd $MOFEM_INSTALL_DIR && cmake -DCMAKE_BUILD_TYPE=Release -DWITH_METAIO=1 -DCMAKE_CXX_FLAGS="-Wall -std=c++11" users_modules
RUN cd $MOFEM_INSTALL_DIR && make
RUN cd $MOFEM_INSTALL_DIR && ctest -D Experimental; echo "Tests Done"
