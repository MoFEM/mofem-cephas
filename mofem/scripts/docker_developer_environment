FROM ubuntu

MAINTAINER likask@wp.pl

# Confif apt-get
RUN echo 'APT::Install-Recommends "0";' > /etc/apt/apt.conf.d/99local

# Install packages
RUN apt-get update && \
apt-get install -y \
file \
zlib1g-dev \
openssh-server \
wget \
valgrind \
git \
g++ \
gdb \
m4 \
automake \
libsigsegv2 \
build-essential \
libtool \
libibverbs-dev \
libblas-dev \
gfortran \
libatlas-dev \
libatlas-base-dev \
libjpeg-dev \
graphviz \
doxygen \
cmake \
gnuplot \
pstack \
ca-certificates \
python \
libadolc-dev \
bison \
flex \
libx11-dev \
libboost-all-dev\
 xauth \
 xterm \
 && rm -rf /var/lib/apt/lists/*

# Set passord
RUN mkdir /var/run/sshd
RUN echo 'root:mofem' | chpasswd
RUN sed -i 's/PermitRootLogin without-password/PermitRootLogin yes/' /etc/ssh/sshd_config
RUN sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config

# SSH login fix. Otherwise user is kicked off after login
RUN sed 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd

ENV NOTVISIBLE "in users profile"
RUN echo "export VISIBLE=now" >> /etc/profile

# SSH .ssh dir
RUN mkdir root/.ssh

# Set petesc version
ENV PETSC_VERSION 3.7.2

# Install petsc opt
RUN cd /opt && git clone https://bitbucket.org/petsc/petsc.git && cd /opt/petsc && git checkout tags/v$PETSC_VERSION
RUN cd /opt/petsc && wget ftp://ftp.unidata.ucar.edu/pub/netcdf/netcdf-4.3.3.1.tar.gz

RUN cd /opt/petsc && \
./configure \
--with-debugging=0 \
--with-mpi=1 \
--download-metis=1 \
--download-parmetis=1 \
--download-hypre=1 \
--download-mumps=1 \
--download-blacs=1 \
--download-moab=1 \
--download-hdf5=1 \
--download-netcdf=/opt/petsc/netcdf-4.3.3.1.tar.gz  \
--download-scalapack && \
make PETSC_DIR=/opt/petsc PETSC_ARCH=arch-linux2-c-opt all

RUN sed -i 's/PATH.*/&\":\/opt\/petsc\/arch-linux2-c-opt\/bin\"/' /etc/environment

# Install tetgen
#RUN cd /opt && \
#wget https://bitbucket.org/likask/mofem-joseph/downloads/tetgen1.5.0.tgz && \
#tar -xvvzf tetgen1.5.0.tgz && cd tetgen1.5.0 && \
#cmake . && \
#make && cp libtet.a lib/ && make clean && rm /opt/tetgen1.5.0.tgz

# SLEP opt //solve eigen value problem
#RUN cd /opt && git clone https://bitbucket.org/slepc/slepc && cd /opt/slepc && git checkout tags/v$PETSC_VERSION
#RUN cd /opt/slepc && PETSC_DIR=/opt/petsc PETSC_ARCH=arch-linux2-c-opt ./configure && make SLEPC_DIR=$PWD PETSC_DIR=/opt/petsc PETSC_ARCH=arch-linux2-c-opt

EXPOSE 22
CMD ["/usr/sbin/sshd", "-D"]
